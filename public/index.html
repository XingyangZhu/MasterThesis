<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Learning-Companion</title>
        <link rel="stylesheet" href="styles/general.css">
        <link rel="stylesheet" href="styles/header.css">
        <link rel="stylesheet" href="styles/layout.css">
        <link rel="stylesheet" href="styles/intro.css">
        <link rel="stylesheet" href="styles/chat.css">
    </head>
    <body>
        <!-- ########################### -->
        <!-- ## Header on top of page ## -->
        <!-- ########################### -->

        <header class="header">
            <h1>Zur Evaluation des Learning-Companions brauche ich Ihre Unterstützung!</h1>
            <img src="images/institute-logo-transparent.png" alt="institute-logo">
        </header>

        <!-- ########################## -->
        <!-- ## Main part of website ## -->
        <!-- ########################## -->

        <div class="grid-container">

            <!-- ################## -->
            <!-- ## Introduction ## -->
            <!-- ################## -->

            <div class="intro-area">
                <!-- info texts -->
                <div class="intro-text-container">
                    <h2>Herzlich willkommen!</h2>
                    <p>
                        Sie sind durch die Online-Umfrage auf diese Webseite weitergeleitet worden, um den Learning-Companion <strong>Laura</strong> zu testen.
                    </p>
                    <p>
                        Stellen Sie sich vor, Sie sind an dem Thema <strong>Sternzeichen</strong> interessiert. 
                        Laura wird Ihnen zu diesem Thema einige Informationen zur Verfügung stellen und ein paar Fragen besprechen.
                    </p>
                    <p>
                        So können Sie mit Laura interagieren:
                    </p>
                    <ul>
                        <li class="introduction-steps">Auf der rechten Seite finden Sie das Chatfenster</li>
                        <li class="introduction-steps">Begrüßen Sie Laura um zu starten</li>
                        <li class="introduction-steps">Um Fragen zu beantworten können Sie die Buttons verwenden</li>
                        <li class="introduction-steps">Kehren Sie am Ende zur Online-Umfrage zurück</li>
                    </ul>
                    <p class="introduction-thanks">
                        Ich wünsche Ihnen viel Spaß und vielen Dank für Ihre Teilnahme!
                    </p>
                </div>
            </div>

            <!-- ################## -->
            <!-- ## Chatbot area ## -->
            <!-- ################## -->

            <div class="chat-area">
                <!-- chat window -->
                <div class="chat-container">

                    <!-- header -->
                    <div class="chat-header">
                        <img src="images/asian-teacher-female.png" alt="teacher">
                        <div class="teacher-info">
                            <div class="teacher-name">
                                Laura
                            </div>
                            <div class="teacher-online-status">
                                online
                            </div>
                        </div>
                    </div>

                    <!-- messages have to be filled using javascript -->
                    <div id="chat-conversation">
                        <div class="answer-selection">
                            <button id="start-button" class="answer-button" onclick="sendMessageFromButton();">Hallo</button>
                        </div>
                    </div>

                    <!-- <div id="chat-conversation">
                        <div class="user-message">
                            Hallo.
                        </div>

                        <div class="teacher-message">
                            Guten Tag. Ich bin Laura.
                        </div>

                        <div class="answer-selection">
                            <button>
                                Answer 1
                            </button>
                            <button>
                                Answer 2
                            </button>
                        </div>

                        <div class="user-message">
                            Hallo.
                        </div>

                        <div class="teacher-message">
                            Guten Tag. Ich bin Prof. Dr. Wang.
                        </div>

                        <div class="teacher-message">
                            <img src="https://image.gala.de/21785740/t/R5/v9/w960/r1.5/-/stier.jpg" alt="institute-logo">
                        </div>

                        <div class="answer-selection">
                            <button>
                                Answer 1
                            </button>
                            <button>
                                Answer 2
                            </button>
                            <button>
                                Answer 3
                            </button>
                        </div>
                        
                        <div class="user-message">
                            Hallo.
                        </div>

                        <div class="teacher-message">
                            Guten Tag. Ich bin Prof. Dr. Wang.
                        </div>

                        <div class="answer-selection">
                            <button class="answer-button">
                                Answer 1
                            </button>
                            <button class="answer-button">
                                Answer 2
                            </button>
                            <button class="answer-button">
                                Answer 3
                            </button>
                            <button class="answer-button">
                                Answer 4
                            </button>
                        </div>
                    </div> -->

                    <!-- input -->
                    <div class="chat-input">
                        <input id="chat-input" type="text" placeholder="Hier können Sie tippen">
                        <button id="chat-button" onclick="sendMessageFromInput();">
                            Senden
                        </button>
                    </div>
                    
                </div>
            </div>

        </div>

        <!-- ################ -->
        <!-- ## Javascript ## -->
        <!-- ################ -->

        <script>

            // Generate random user id for each user. (Current time in seconds)
            const userId = ( new Date().getTime() ).toString();

            // Container for all messages.
            let messages = [];

            // Data class to know which user wrote what message.
            class ChatObject {
                constructor(user, text, buttons=[]) {
                    this.user = user;
                    this.text = text;
                    this.buttons = buttons;
                }
            }

            async function sendMessageFromButton()
            {
                // Get clicked button id.
                const buttonId = event.target.id;
                // Get button element.
                const button = document.getElementById(buttonId);
                // Get button text.
                const buttonText = button.innerHTML;

                // Create new ChatObject with given input text.
                message = new ChatObject('person', buttonText);
                // Add message to messages array.
                messages.unshift(message);


                // Update chat conversation with new message.
                render();


                // Send message to dialogflow and get response.
                let answer = await getResponse(message);
                // Add answer to messages array.
                messages.unshift(answer);


                // Update chat conversation with new response.
                render();
            }

            async function sendMessageFromInput()
            {
                // Get chat input element.
                let input = document.getElementById('chat-input');
                // Get content of chat input field.                
                let inputText = input.value;
                // Create new ChatObject with given input text.
                let message = new ChatObject('person', inputText);
                // Do nothing if nothing was entered.
                if (inputText == "") {
                    return;
                }
                // Add message to messages array.
                messages.unshift(message);
                // Clean up input field text.
                input.value = "";


                // Update chat conversation with new message.
                render();


                // Send message to dialogflow and get response.
                let answer = await getResponse(message);
                // Add answer to messages array.
                messages.unshift(answer);


                // Update chat conversation with new response.
                render();

            }

            async function getResponse(message) {
                // Set options for HTTP request to the node js server.
                const options = {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "userText": message.text,
                        "userId"  : userId
                    }),
                };
                // Send message to node js backend server that forwards the request to dialogflow.
                const response = await fetch('/text_query', options);
                // Unwrap response into json format.
                const data = await response.json();

                // console.log("Client", data);

                // Create answer.
                let answer = new ChatObject('teacher', data.message, data.buttons);
                // Return the answer.
                return answer;
            }

            function render() {
                // Get current chat conversation element.
                let conversation = document.getElementById('chat-conversation');
                // Reset all messages currently displayed.
                conversation.innerHTML = "";
                // Create an element for all elements in messages array.
                messages.forEach(
                    function (chatObject, chatObjectIndex) {
                        // Add buttons to chat. (If they exist)
                        addChatButtons(conversation, chatObject, chatObjectIndex);

                        // Add message to chat.
                        addChatMessage(conversation, chatObject);
                    }
                )
            }

            function addChatButtons(conversation, chatObject, chatObjectIndex) {
                // Check if buttons exist.
                if (chatObject.buttons.length > 0) {
                    // Create new button container element.
                    let buttonContainer = document.createElement('div');
                    // Set element class.
                    buttonContainer.className = 'answer-selection';

                    // Fill container with buttons.
                    chatObject.buttons.forEach(
                        function (buttonText, buttonIndex) {
                            // Only newest buttons?
                            if (chatObjectIndex == 0) {
                                // Create new button element.
                                let button = document.createElement('button');
                                // Set button text.
                                button.innerHTML = buttonText;
                                // Set button class.
                                button.className = 'answer-button';
                                // Set button id.
                                button.id = chatObject.text + buttonText; // TODO: Proper id?
                                // Set onClick method.
                                button.addEventListener("click", sendMessageFromButton);
                                // Deactivate buttons for old messages. (Message 0 is most recent message from dialogflow)
                                if (chatObjectIndex != 0) {
                                    button.disabled = true;
                                }
                                // Append button to button container.
                                buttonContainer.appendChild(button);

                                // Check if more than 6 buttons.
                                if (buttonIndex == 5 && chatObject.buttons.length > 6) {
                                    // Append container and create a new one.
                                    conversation.appendChild(buttonContainer);
                                    buttonContainer = document.createElement('div');
                                    buttonContainer.className = 'answer-selection';
                                }
                            }
                        }
                    );

                    // Append button container element to conversation.
                    conversation.appendChild(buttonContainer);
                }
            }

            function addChatMessage(conversation, chatObject) {
                // Create new div element for each message.
                let element = document.createElement('div');
                // Set text of message.
                element.innerText = chatObject.text;
                // Set class depending on which user.
                if (chatObject.user == 'person') {
                    element.className = 'user-message';
                }
                else {
                    element.className = 'teacher-message';
                }
                // Append element to conversation.
                conversation.appendChild(element);
            }

            // Add event listener to input field.
            let chatInput = document.getElementById('chat-input');
            // Execute a function when the user presses a key on the keyboard
            chatInput.addEventListener("keypress", function(event) {
                // If the user presses the "Enter" key on the keyboard
                if (event.key === "Enter") {
                    // Cancel the default action, if needed
                    event.preventDefault();
                    // Trigger the button element with a click
                    document.getElementById("chat-button").click();
                }
            });

        </script>

    </body>
</html>